<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>オンライン リーグ戦マネージャー</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root { --primary: #1565C0; --accent: #FFC107; --bg: #f4f6f8; --text: #333; --danger: #D32F2F; }
        body { font-family: sans-serif; margin: 0; background: var(--bg); color: var(--text); padding-bottom: 20px;}
        header { background: var(--primary); color: white; padding: 15px; text-align: center; }
        h1 { margin: 0; font-size: 1.2rem; }
        .container { max-width: 800px; margin: 0 auto; padding: 10px; }
        
        /* ID入力エリア */
        #loginArea { background: white; padding: 20px; border-radius: 8px; text-align: center; margin-top: 50px; }
        #appArea { display: none; } /* 最初は隠す */

        /* タブ */
        .tabs { display: flex; margin-bottom: 15px; background: #ddd; border-radius: 8px; overflow: hidden; }
        .tab { flex: 1; padding: 10px; text-align: center; cursor: pointer; background: #eee; font-weight: bold; }
        .tab.active { background: var(--primary); color: white; }
        .content { display: none; }
        .content.active { display: block; }

        /* カード・入力 */
        .card { background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        input, select, button { width: 100%; padding: 10px; margin-bottom: 10px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; }
        button { background: var(--primary); color: white; border: none; font-weight: bold; cursor: pointer; }
        button.secondary { background: #757575; }
        
        /* テーブル */
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th, td { padding: 8px; text-align: center; border-bottom: 1px solid #eee; }
        th { background: #f0f0f0; }
        .rank-1 { background: #fff8e1; border-left: 4px solid var(--accent); }
        
        /* 試合リスト */
        .match-item { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding: 10px 0; }
        .score-box { background: #eee; padding: 5px 10px; border-radius: 4px; font-weight: bold; margin: 0 10px; }
        
        .loading { opacity: 0.5; pointer-events: none; }
    </style>
</head>
<body>

<header>
    <h1 id="headerTitle">⚽ オンライン リーグ</h1>
</header>

<div class="container">
    
    <div id="loginArea">
        <h2>大会IDを入力</h2>
        <p style="font-size:0.8rem; color:#666;">チーム全員で同じIDを使ってください</p>
        <input type="text" id="leagueIdInput" placeholder="例: cup2025" style="text-align:center; font-size:1.2rem;">
        <button onclick="joinLeague()">参加 / 作成する</button>
    </div>

    <div id="appArea">
        <div style="text-align:right; font-size:0.8rem; margin-bottom:5px;">ID: <span id="displayId" style="font-weight:bold;"></span></div>
        
        <div class="tabs">
            <div class="tab active" onclick="showTab('standings')">順位表</div>
            <div class="tab" onclick="showTab('matches')">試合・登録</div>
            <div class="tab" onclick="showTab('settings')">設定</div>
        </div>

        <div id="standings" class="content active">
            <div class="card">
                <table id="standingsTable">
                    <thead>
                        <tr><th>順</th><th style="text-align:left;">チーム</th><th>点</th><th>得失</th><th>試</th></tr>
                    </thead>
                    <tbody id="standingsBody"></tbody>
                </table>
            </div>
        </div>

        <div id="matches" class="content">
            <div class="card">
                <h3>試合結果の入力</h3>
                <div style="display:flex; gap:5px;">
                    <select id="teamA"></select> <span>VS</span> <select id="teamB"></select>
                </div>
                <div style="display:flex; gap:5px;">
                    <input type="number" id="scoreA" placeholder="点"> - <input type="number" id="scoreB" placeholder="点">
                </div>
                <button onclick="addMatch()">結果を送信</button>
            </div>
            
            <div class="card">
                <h3>試合履歴</h3>
                <div id="matchList"></div>
            </div>
        </div>

        <div id="settings" class="content">
            <div class="card">
                <h3>チーム登録</h3>
                <input type="text" id="newTeamName" placeholder="チーム名">
                <button onclick="addTeam()">チームを追加</button>
                <div id="teamListRaw" style="margin-top:10px; font-size:0.8rem; color:#666;"></div>
            </div>
            
            <div class="card">
                <h3>大会名設定</h3>
                <input type="text" id="tournamentNameInput" placeholder="大会名">
                <button class="secondary" onclick="updateTournamentName()">大会名を更新</button>
            </div>
            
            <button onclick="location.reload()" style="background:#666; margin-top:20px;">ログアウト（ID入力へ）</button>
        </div>
    </div>
</div>

<script>
    // ==========================================
    // ▼▼▼ ここにFirebaseの設定を貼り付け ▼▼▼
    // ==========================================
    const firebaseConfig = {
        apiKey: "AIzaSyAwnb4ii-Rrh6eyNBELXQkAIzc64VTH3v4",
        authDomain: "your-project.firebaseapp.com",
        databaseURL: "https://your-project-default-rtdb.firebaseio.com", // ←重要: これがないと動きません
        projectId: "your-project",
        storageBucket: "your-project.appspot.com",
        messagingSenderId: "123456789",
        appId: "1:123456789:web:xxxxxxxxx"
    };
    // ▲▲▲ ここまで ▲▲▲
    // ==========================================

    // Firebase初期化
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.database();

    let currentLeagueId = "";
    let appData = { teams: {}, matches: {}, name: "オンラインリーグ" };

    // --- 1. ログイン処理 ---
    function joinLeague() {
        const id = document.getElementById('leagueIdInput').value.trim();
        if (!id) return alert("IDを入力してください");
        
        currentLeagueId = id;
        document.getElementById('displayId').innerText = id;
        document.getElementById('loginArea').style.display = 'none';
        document.getElementById('appArea').style.display = 'block';

        // リアルタイムリスナー開始（データが変わるたびにここが動く）
        db.ref('leagues/' + currentLeagueId).on('value', (snapshot) => {
            const val = snapshot.val();
            if (val) {
                appData = val;
                // データ構造の初期化（空の場合のエラー防止）
                if(!appData.teams) appData.teams = {};
                if(!appData.matches) appData.matches = {};
                if(!appData.name) appData.name = "オンラインリーグ";
            } else {
                // 新規IDの場合
                appData = { teams: {}, matches: {}, name: "新規大会" };
            }
            renderAll();
        });
    }

    // --- 2. データ書き込み処理 ---
    
    function addTeam() {
        const name = document.getElementById('newTeamName').value.trim();
        if (!name) return;
        const newRef = db.ref('leagues/' + currentLeagueId + '/teams').push();
        newRef.set({ name: name, id: newRef.key });
        document.getElementById('newTeamName').value = "";
    }

    function updateTournamentName() {
        const name = document.getElementById('tournamentNameInput').value.trim();
        if(!name) return;
        db.ref('leagues/' + currentLeagueId).update({ name: name });
        alert("大会名を更新しました");
    }

    function addMatch() {
        const tA = document.getElementById('teamA').value;
        const tB = document.getElementById('teamB').value;
        const sA = document.getElementById('scoreA').value;
        const sB = document.getElementById('scoreB').value;

        if (!tA || !tB || tA === tB || sA === "" || sB === "") return alert("入力内容を確認してください");

        const newRef = db.ref('leagues/' + currentLeagueId + '/matches').push();
        newRef.set({
            teamA: tA, teamB: tB,
            scoreA: parseInt(sA), scoreB: parseInt(sB),
            timestamp: firebase.database.ServerValue.TIMESTAMP
        });

        document.getElementById('scoreA').value = "";
        document.getElementById('scoreB').value = "";
        showTab('standings');
    }

    function deleteMatch(key) {
        if(confirm("削除しますか？")) {
            db.ref('leagues/' + currentLeagueId + '/matches/' + key).remove();
        }
    }

    // --- 3. 描画・計算処理 ---

    function renderAll() {
        document.getElementById('headerTitle').innerText = "⚽ " + appData.name;
        document.getElementById('tournamentNameInput').value = appData.name;

        // チームリスト（配列化）
        const teams = Object.values(appData.teams || {});
        const matches = Object.values(appData.matches || {});
        // キーも含めるために変換
        const matchesWithKey = Object.keys(appData.matches || {}).map(key => ({
            ...appData.matches[key], key: key
        })).sort((a,b) => b.timestamp - a.timestamp); // 新しい順

        // チーム選択肢更新
        const selA = document.getElementById('teamA');
        const selB = document.getElementById('teamB');
        const currentA = selA.value; 
        const currentB = selB.value;
        
        selA.innerHTML = '<option value="">チームA</option>';
        selB.innerHTML = '<option value="">チームB</option>';
        
        let teamListHtml = "";
        teams.forEach(t => {
            selA.innerHTML += `<option value="${t.id}">${t.name}</option>`;
            selB.innerHTML += `<option value="${t.id}">${t.name}</option>`;
            teamListHtml += `[${t.name}] `;
        });
        selA.value = currentA; selB.value = currentB;
        document.getElementById('teamListRaw').innerText = "登録済: " + teamListHtml;

        // 試合履歴描画
        const matchListEl = document.getElementById('matchList');
        matchListEl.innerHTML = "";
        matchesWithKey.forEach(m => {
            const nameA = appData.teams[m.teamA]?.name || "不明";
            const nameB = appData.teams[m.teamB]?.name || "不明";
            matchListEl.innerHTML += `
                <div class="match-item">
                    <div style="flex:1; text-align:right;">${nameA}</div>
                    <div class="score-box">${m.scoreA} - ${m.scoreB}</div>
                    <div style="flex:1; text-align:left;">${nameB}</div>
                    <button onclick="deleteMatch('${m.key}')" style="width:auto; padding:2px 8px; font-size:12px; background:#999;">×</button>
                </div>
            `;
        });

        // 順位表計算
        let stats = {};
        teams.forEach(t => {
            stats[t.id] = { name: t.name, pts: 0, gd: 0, played: 0, gf: 0 };
        });

        matches.forEach(m => {
            if(!stats[m.teamA] || !stats[m.teamB]) return;
            const sA = parseInt(m.scoreA);
            const sB = parseInt(m.scoreB);
            
            stats[m.teamA].played++; stats[m.teamB].played++;
            stats[m.teamA].gd += (sA - sB); stats[m.teamB].gd += (sB - sA);
            stats[m.teamA].gf += sA; stats[m.teamB].gf += sB;

            if(sA > sB) { stats[m.teamA].pts += 3; }
            else if(sA < sB) { stats[m.teamB].pts += 3; }
            else { stats[m.teamA].pts += 1; stats[m.teamB].pts += 1; }
        });

        const sorted = Object.values(stats).sort((a,b) => {
            if(b.pts !== a.pts) return b.pts - a.pts;
            if(b.gd !== a.gd) return b.gd - a.gd;
            return b.gf - a.gf;
        });

        const tbody = document.getElementById('standingsBody');
        tbody.innerHTML = "";
        sorted.forEach((t, i) => {
            tbody.innerHTML += `
                <tr class="${i===0?'rank-1':''}">
                    <td>${i+1}</td>
                    <td style="text-align:left; font-weight:bold;">${t.name}</td>
                    <td style="font-weight:bold; color:#1565C0;">${t.pts}</td>
                    <td>${t.gd>0?'+'+t.gd:t.gd}</td>
                    <td>${t.played}</td>
                </tr>
            `;
        });
    }

    function showTab(id) {
        document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        event.target.classList.add('active');
    }
</script>
</body>
</html>
