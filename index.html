<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ ãƒªãƒ¼ã‚°æˆ¦ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root { --primary: #1565C0; --accent: #FFC107; --bg: #f4f6f8; --text: #333; --danger: #D32F2F; --edit: #4CAF50; }
        body { font-family: sans-serif; margin: 0; background: var(--bg); color: var(--text); padding-bottom: 20px;}
        header { background: var(--primary); color: white; padding: 15px; text-align: center; }
        h1 { margin: 0; font-size: 1.2rem; }
        .container { max-width: 800px; margin: 0 auto; padding: 10px; }
        
        /* IDå…¥åŠ›ã‚¨ãƒªã‚¢ */
        #loginArea { background: white; padding: 20px; border-radius: 8px; text-align: center; margin-top: 50px; }
        #appArea { display: none; }

        /* ã‚¿ãƒ– */
        .tabs { display: flex; margin-bottom: 15px; background: #ddd; border-radius: 8px; overflow: hidden; }
        .tab { flex: 1; padding: 10px; text-align: center; cursor: pointer; background: #eee; font-weight: bold; }
        .tab.active { background: var(--primary); color: white; }
        .content { display: none; }
        .content.active { display: block; }

        /* ã‚«ãƒ¼ãƒ‰ãƒ»å…¥åŠ› */
        .card { background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        h3 { margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 5px; color: var(--primary); font-size: 1rem; }
        input, select, button { width: 100%; padding: 10px; margin-bottom: 10px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; }
        button { background: var(--primary); color: white; border: none; font-weight: bold; cursor: pointer; }
        button.secondary { background: #757575; }
        button.edit-btn { background: var(--edit); width: auto; padding: 4px 8px; font-size: 12px; margin-right: 5px; }
        button.delete-btn { background: #999; width: auto; padding: 4px 8px; font-size: 12px; }
        
        /* ãƒ†ãƒ¼ãƒ–ãƒ« */
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th, td { padding: 8px; text-align: center; border-bottom: 1px solid #eee; }
        th { background: #f0f0f0; }
        .rank-1 { background: #fff8e1; border-left: 4px solid var(--accent); }
        
        /* ãƒªã‚¹ãƒˆã‚¢ã‚¤ãƒ†ãƒ  (è©¦åˆãƒ»ãƒãƒ¼ãƒ å…±é€š) */
        .list-item { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding: 10px 0; }
        .match-info { flex: 1; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .score-box { background: #eee; padding: 5px 10px; border-radius: 4px; font-weight: bold; min-width: 40px; text-align: center;}
        .item-actions { display: flex; gap: 5px; }

        .editing-notice { background: #fff3cd; color: #856404; padding: 10px; border-radius: 4px; margin-bottom: 10px; display: none; text-align: center; border: 1px solid #ffeeba; }
    </style>
</head>
<body>

<header>
    <h1 id="headerTitle">âš½ ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ ãƒªãƒ¼ã‚°</h1>
</header>

<div class="container">
    
    <div id="loginArea">
        <h2>å¤§ä¼šIDã‚’å…¥åŠ›</h2>
        <input type="text" id="leagueIdInput" placeholder="ä¾‹: cup2025" style="text-align:center; font-size:1.2rem;">
        <button onclick="joinLeague()">å‚åŠ  / ä½œæˆã™ã‚‹</button>
    </div>

    <div id="appArea">
        <div style="text-align:right; font-size:0.8rem; margin-bottom:5px;">ID: <span id="displayId" style="font-weight:bold;"></span></div>
        
        <div class="tabs">
            <div class="tab active" onclick="showTab('standings')">é †ä½è¡¨ & çµæœ</div>
            <div class="tab" onclick="showTab('inputMatch')">è©¦åˆå…¥åŠ›</div>
            <div class="tab" onclick="showTab('settings')">è¨­å®š</div>
        </div>

        <div id="standings" class="content active">
            <div class="card">
                <table id="standingsTable">
                    <thead>
                        <tr><th>é †</th><th style="text-align:left;">ãƒãƒ¼ãƒ </th><th>ç‚¹</th><th>å¾—å¤±</th><th>è©¦</th></tr>
                    </thead>
                    <tbody id="standingsBody"></tbody>
                </table>
            </div>

            <div class="card">
                <h3>è©¦åˆçµæœä¸€è¦§</h3>
                <div id="matchList"></div>
            </div>
        </div>

        <div id="inputMatch" class="content">
            <div class="card">
                <h3 id="inputFormTitle">è©¦åˆçµæœã®å…¥åŠ›</h3>
                
                <div id="editingNotice" class="editing-notice">
                    ğŸ“ éå»ã®ãƒ‡ãƒ¼ã‚¿ã‚’ç·¨é›†ä¸­ã§ã™
                    <button onclick="cancelEdit()" style="width:auto; padding:2px 8px; margin-left:10px; background:#666; font-size:0.8rem;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                </div>

                <div style="display:flex; gap:5px;">
                    <select id="teamA"></select> <span>VS</span> <select id="teamB"></select>
                </div>
                <div style="display:flex; gap:5px;">
                    <input type="number" id="scoreA" placeholder="ç‚¹"> - <input type="number" id="scoreB" placeholder="ç‚¹">
                </div>
                
                <button id="submitMatchBtn" onclick="saveMatch()">çµæœã‚’ç™»éŒ²</button>
            </div>
        </div>

        <div id="settings" class="content">
            <div class="card">
                <h3>ãƒãƒ¼ãƒ ç™»éŒ²ãƒ»ç·¨é›†</h3>
                <input type="text" id="newTeamName" placeholder="æ–°è¦ãƒãƒ¼ãƒ å">
                <button onclick="addTeam()">ãƒãƒ¼ãƒ ã‚’è¿½åŠ </button>
                
                <h4 style="margin: 15px 0 5px 0; font-size: 0.9rem; color: #666;">ç™»éŒ²æ¸ˆã¿ãƒãƒ¼ãƒ ä¸€è¦§</h4>
                <div id="teamListSettings"></div>
            </div>
            
            <div class="card">
                <h3>å¤§ä¼šåè¨­å®š</h3>
                <input type="text" id="tournamentNameInput" placeholder="å¤§ä¼šå">
                <button class="secondary" onclick="updateTournamentName()">å¤§ä¼šåã‚’æ›´æ–°</button>
            </div>
            
            <button onclick="location.reload()" style="background:#666; margin-top:20px;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>
    </div>
</div>

<script>
// ==========================================
    // â–¼â–¼â–¼ ã“ã“ã«Firebaseã®è¨­å®šã‚’è²¼ã‚Šä»˜ã‘ â–¼â–¼â–¼
    // ==========================================
    const firebaseConfig = {
        apiKey: "AIzaSyAwnb4ii-Rrh6eyNBELXQkAIzc64VTH3v4",
        authDomain: "soccer-league-app-f3c42.firebaseapp.com",
        
        // â˜…ã“ã“ã‚’ç”»åƒã®æƒ…å ±ã«åˆã‚ã›ã¦ä¿®æ­£ã—ã¾ã—ãŸï¼
        databaseURL: "https://soccer-league-app-f3c42-default-rtdb.asia-southeast1.firebasedatabase.app",
        
        projectId: "soccer-league-app-f3c42",
        storageBucket: "soccer-league-app-f3c42.appspot.com",
        messagingSenderId: "554260326944",
        appId: "1:554260326944:web:a512db3bb6202538986a45"
    };
    // â–²â–²â–² ã“ã“ã¾ã§ â–²â–²â–²
    // ==========================================

    // FirebaseåˆæœŸåŒ–
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.database();

    let currentLeagueId = "";
    let appData = { teams: {}, matches: {}, name: "ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒªãƒ¼ã‚°" };
    
    // ç·¨é›†ç”¨å¤‰æ•°
    let isEditing = false;
    let editingMatchKey = null;

    // --- 1. ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç† ---
    function joinLeague() {
        const id = document.getElementById('leagueIdInput').value.trim();
        if (!id) return alert("IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        
        currentLeagueId = id;
        document.getElementById('displayId').innerText = id;
        document.getElementById('loginArea').style.display = 'none';
        document.getElementById('appArea').style.display = 'block';

        db.ref('leagues/' + currentLeagueId).on('value', (snapshot) => {
            const val = snapshot.val();
            if (val) {
                appData = val;
                if(!appData.teams) appData.teams = {};
                if(!appData.matches) appData.matches = {};
                if(!appData.name) appData.name = "ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒªãƒ¼ã‚°";
            } else {
                appData = { teams: {}, matches: {}, name: "æ–°è¦å¤§ä¼š" };
            }
            renderAll();
        });
    }

    // --- 2. ãƒ‡ãƒ¼ã‚¿æ“ä½œï¼ˆãƒãƒ¼ãƒ ï¼‰ ---
    
    function addTeam() {
        const name = document.getElementById('newTeamName').value.trim();
        if (!name) return;
        const newRef = db.ref('leagues/' + currentLeagueId + '/teams').push();
        newRef.set({ name: name, id: newRef.key });
        document.getElementById('newTeamName').value = "";
    }

    // ãƒãƒ¼ãƒ åå¤‰æ›´
    function editTeam(key) {
        const team = appData.teams[key];
        if(!team) return;
        
        const newName = prompt("æ–°ã—ã„ãƒãƒ¼ãƒ åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", team.name);
        if (newName && newName.trim() !== "") {
            db.ref('leagues/' + currentLeagueId + '/teams/' + key).update({ name: newName.trim() })
                .then(() => alert("ãƒãƒ¼ãƒ åã‚’å¤‰æ›´ã—ã¾ã—ãŸ"));
        }
    }

    // ãƒãƒ¼ãƒ å‰Šé™¤
    function deleteTeam(key) {
        if(confirm("ã“ã®ãƒãƒ¼ãƒ ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nâ€»æ³¨æ„: ã“ã®ãƒãƒ¼ãƒ ã®éå»ã®è©¦åˆçµæœè¡¨ç¤ºãŒãŠã‹ã—ããªã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚")) {
            db.ref('leagues/' + currentLeagueId + '/teams/' + key).remove();
        }
    }

    // --- 3. ãƒ‡ãƒ¼ã‚¿æ“ä½œï¼ˆè©¦åˆãƒ»å¤§ä¼šåï¼‰ ---

    function updateTournamentName() {
        const name = document.getElementById('tournamentNameInput').value.trim();
        if(!name) return;
        db.ref('leagues/' + currentLeagueId).update({ name: name });
        alert("å¤§ä¼šåã‚’æ›´æ–°ã—ã¾ã—ãŸ");
    }

    function saveMatch() {
        const tA = document.getElementById('teamA').value;
        const tB = document.getElementById('teamB').value;
        const sA = document.getElementById('scoreA').value;
        const sB = document.getElementById('scoreB').value;

        if (!tA || !tB || tA === tB || sA === "" || sB === "") return alert("å…¥åŠ›å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„");

        const matchData = {
            teamA: tA, teamB: tB,
            scoreA: parseInt(sA), scoreB: parseInt(sB),
            timestamp: firebase.database.ServerValue.TIMESTAMP
        };

        if (isEditing && editingMatchKey) {
            db.ref('leagues/' + currentLeagueId + '/matches/' + editingMatchKey).update(matchData)
                .then(() => {
                    alert("è©¦åˆçµæœã‚’æ›´æ–°ã—ã¾ã—ãŸ");
                    cancelEdit();
                    showTab('standings');
                });
        } else {
            const newRef = db.ref('leagues/' + currentLeagueId + '/matches').push();
            newRef.set(matchData)
                .then(() => {
                    document.getElementById('scoreA').value = "";
                    document.getElementById('scoreB').value = "";
                    showTab('standings');
                });
        }
    }

    function deleteMatch(key) {
        if(confirm("ã“ã®è©¦åˆè¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
            db.ref('leagues/' + currentLeagueId + '/matches/' + key).remove();
        }
    }

    function editMatch(key) {
        const match = appData.matches[key];
        if(!match) return;
        isEditing = true;
        editingMatchKey = key;
        document.getElementById('teamA').value = match.teamA;
        document.getElementById('teamB').value = match.teamB;
        document.getElementById('scoreA').value = match.scoreA;
        document.getElementById('scoreB').value = match.scoreB;
        document.getElementById('inputFormTitle').innerText = "è©¦åˆçµæœã®ç·¨é›†";
        document.getElementById('submitMatchBtn').innerText = "æ›´æ–°ã™ã‚‹";
        document.getElementById('submitMatchBtn').style.background = "#4CAF50";
        document.getElementById('editingNotice').style.display = "block";
        showTab('inputMatch');
    }

    function cancelEdit() {
        isEditing = false;
        editingMatchKey = null;
        document.getElementById('scoreA').value = "";
        document.getElementById('scoreB').value = "";
        document.getElementById('inputFormTitle').innerText = "è©¦åˆçµæœã®å…¥åŠ›";
        document.getElementById('submitMatchBtn').innerText = "çµæœã‚’ç™»éŒ²";
        document.getElementById('submitMatchBtn').style.background = "";
        document.getElementById('editingNotice').style.display = "none";
    }

    // --- 4. æç”»ãƒ»è¨ˆç®—å‡¦ç† ---

    function renderAll() {
        document.getElementById('headerTitle').innerText = "âš½ " + appData.name;
        document.getElementById('tournamentNameInput').value = appData.name;

        // ãƒ‡ãƒ¼ã‚¿æº–å‚™
        const teams = Object.values(appData.teams || {});
        const matchesWithKey = Object.keys(appData.matches || {}).map(key => ({
            ...appData.matches[key], key: key
        })).sort((a,b) => b.timestamp - a.timestamp);

        // --- ãƒãƒ¼ãƒ é¸æŠè‚¢ & è¨­å®šç”»é¢ãƒªã‚¹ãƒˆã®æ›´æ–° ---
        const selA = document.getElementById('teamA');
        const selB = document.getElementById('teamB');
        const currentValA = selA.value;
        const currentValB = selB.value;
        const teamListSettings = document.getElementById('teamListSettings');
        
        let optionsHtml = '<option value="">é¸æŠ</option>';
        teamListSettings.innerHTML = ""; // ã‚¯ãƒªã‚¢

        if(teams.length === 0) {
            teamListSettings.innerHTML = "<div style='color:#999; padding:5px;'>ãƒãƒ¼ãƒ ãŒã‚ã‚Šã¾ã›ã‚“</div>";
        }

        teams.forEach(t => {
            // ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ç”¨
            optionsHtml += `<option value="${t.id}">${t.name}</option>`;
            
            // è¨­å®šç”»é¢ã®ãƒªã‚¹ãƒˆæç”»
            teamListSettings.innerHTML += `
                <div class="list-item">
                    <span style="flex:1; font-weight:bold;">${t.name}</span>
                    <div class="item-actions">
                        <button class="edit-btn" onclick="editTeam('${t.id}')">ç·¨é›†</button>
                        <button class="delete-btn" onclick="deleteTeam('${t.id}')">å‰Šé™¤</button>
                    </div>
                </div>
            `;
        });
        
        selA.innerHTML = optionsHtml;
        selB.innerHTML = optionsHtml;
        
        // é¸æŠçŠ¶æ…‹ã®å¾©å…ƒ
        if(isEditing) {
            selA.value = document.getElementById('teamA').value || currentValA;
            selB.value = document.getElementById('teamB').value || currentValB;
        } else if (currentValA && currentValB) {
            selA.value = currentValA;
            selB.value = currentValB;
        }

        // --- è©¦åˆå±¥æ­´æç”» ---
        const matchListEl = document.getElementById('matchList');
        matchListEl.innerHTML = "";
        if(matchesWithKey.length === 0) {
             matchListEl.innerHTML = "<div style='text-align:center; color:#999; padding:10px;'>è©¦åˆãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“</div>";
        } else {
            matchesWithKey.forEach(m => {
                const nameA = appData.teams[m.teamA]?.name || "å‰Šé™¤æ¸ˆ";
                const nameB = appData.teams[m.teamB]?.name || "å‰Šé™¤æ¸ˆ";
                matchListEl.innerHTML += `
                    <div class="list-item">
                        <div class="match-info">
                            <span style="flex:1; text-align:right; font-size:0.9rem;">${nameA}</span>
                            <span class="score-box">${m.scoreA} - ${m.scoreB}</span>
                            <span style="flex:1; text-align:left; font-size:0.9rem;">${nameB}</span>
                        </div>
                        <div class="item-actions">
                            <button class="edit-btn" onclick="editMatch('${m.key}')">ç·¨é›†</button>
                            <button class="delete-btn" onclick="deleteMatch('${m.key}')">å‰Šé™¤</button>
                        </div>
                    </div>
                `;
            });
        }

        // --- é †ä½è¡¨è¨ˆç®— ---
        let stats = {};
        teams.forEach(t => {
            stats[t.id] = { name: t.name, pts: 0, gd: 0, played: 0, gf: 0 };
        });

        Object.values(appData.matches || {}).forEach(m => {
            if(!stats[m.teamA] || !stats[m.teamB]) return;
            const sA = parseInt(m.scoreA);
            const sB = parseInt(m.scoreB);
            
            stats[m.teamA].played++; stats[m.teamB].played++;
            stats[m.teamA].gd += (sA - sB); stats[m.teamB].gd += (sB - sA);
            stats[m.teamA].gf += sA; stats[m.teamB].gf += sB;

            if(sA > sB) { stats[m.teamA].pts += 3; }
            else if(sA < sB) { stats[m.teamB].pts += 3; }
            else { stats[m.teamA].pts += 1; stats[m.teamB].pts += 1; }
        });

        const sorted = Object.values(stats).sort((a,b) => {
            if(b.pts !== a.pts) return b.pts - a.pts;
            if(b.gd !== a.gd) return b.gd - a.gd;
            return b.gf - a.gf;
        });

        const tbody = document.getElementById('standingsBody');
        tbody.innerHTML = "";
        sorted.forEach((t, i) => {
            tbody.innerHTML += `
                <tr class="${i===0?'rank-1':''}">
                    <td>${i+1}</td>
                    <td style="text-align:left; font-weight:bold;">${t.name}</td>
                    <td style="font-weight:bold; color:#1565C0;">${t.pts}</td>
                    <td>${t.gd>0?'+'+t.gd:t.gd}</td>
                    <td>${t.played}</td>
                </tr>
            `;
        });
    }

    function showTab(id) {
        document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        const tabBtn = Array.from(document.querySelectorAll('.tab')).find(el => el.getAttribute('onclick').includes(id));
        if(tabBtn) tabBtn.classList.add('active');
    }
</script>
</body>
</html>
